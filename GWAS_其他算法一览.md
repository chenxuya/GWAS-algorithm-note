# 压缩混合线性模型(CMLM)
压缩混合线性模型（Compressed Mixed Linear Model, CMLM）是在混合线性模型（MLM）基础上的一种改进，用于提高GWAS分析的效率和精度。CMLM的核心思想是通过**样本聚类**减少模型中个体的数量，从而压缩随机效应矩阵的规模。这种压缩过程不仅减少了计算量，也提高了对多态性SNP的检测效率。

下面我们详细分析CMLM的数学原理和求解过程。

---

### **1. 压缩混合线性模型的基本结构**

CMLM的数学表达式和传统的混合线性模型类似，可以表示为：

$$
Y = X\beta + Z_c u_c + \epsilon
$$

其中：
- $ Y $ 是 $ n \times 1 $ 的表型向量，表示 $ n $ 个个体的表型值。
- $ X $ 是 $ n \times p $ 的设计矩阵，包含固定效应的自变量（包括SNP基因型和协变量，如性别、年龄等）。
- $ \beta $ 是 $ p \times 1 $ 的固定效应系数向量，表示SNP基因型对表型的固定效应。
- $ Z_c $ 是 $ n \times q $ 的压缩设计矩阵，表示压缩后的随机效应矩阵。
- $ u_c $ 是 $ q \times 1 $ 的随机效应向量，假设 $ u_c \sim N(0, \sigma_u^2 I_q) $，其中 $ I_q $ 是 $ q \times q $ 的单位矩阵。
- $ \epsilon $ 是 $ n \times 1 $ 的误差项向量，假设 $ \epsilon \sim N(0, \sigma_\epsilon^2 I_n) $。

在CMLM中，随机效应被压缩成聚类组的效应，而非每个个体的效应。这种压缩显著减少了模型中的参数数量，使得计算变得更高效。

---

### **2. 压缩的原理：样本聚类**

在传统的MLM中，随机效应矩阵 $ Z $ 直接作用于每个个体，导致方差矩阵的维度随着样本数量 $ n $ 增加，计算复杂度很高。CMLM通过将样本聚类来减少随机效应的维度，步骤如下：

1. **样本聚类**：基于亲缘关系矩阵 $ K $ 或其他方法，将 $ n $ 个个体聚类成 $ q $ 个群组。每个群组代表一些遗传相似性较高的个体。
   
2. **构建压缩矩阵** $ Z_c $：将原设计矩阵 $ Z $ 压缩成新的设计矩阵 $ Z_c $，其中 $ Z_c $ 的维度为 $ n \times q $。$ Z_c $ 表示每个个体在聚类后所属的群组。

3. **群组的随机效应**：每个群组的随机效应表示一组遗传相似个体的影响，这样每个群组只需要一个随机效应参数 $ u_c $。

通过这种聚类，CMLM有效减少了计算量，特别是在大样本研究中，这种压缩显著提高了计算效率。

---

### **3. CMLM的协方差结构**

在CMLM中，表型 $ Y $ 的协方差矩阵可以表示为：

$$
V = \sigma_u^2 Z_c Z_c^T + \sigma_\epsilon^2 I_n
$$

其中：

- $ \sigma_u^2 Z_c Z_c^T $ 是压缩后的随机效应协方差矩阵，反映了群组间的遗传相似性带来的变异。
- $ \sigma_\epsilon^2 I_n $ 是误差项的协方差矩阵。

### **4. 参数估计的过程**

由于CMLM仍然是混合线性模型的一种，我们可以使用**最大似然估计（Maximum Likelihood, ML）** 或 **限制最大似然估计（Restricted Maximum Likelihood, REML）** 来估计参数。过程如下：

#### (1) 对数似然函数

对数似然函数可以写为：

$$
\ell(\beta, \sigma_u^2, \sigma_\epsilon^2 | Y) = -\frac{n}{2} \ln(2\pi) - \frac{1}{2} \ln |V| - \frac{1}{2} (Y - X\beta)^T V^{-1} (Y - X\beta)
$$

#### (2) 固定效应 $ \beta $ 的估计

类似于传统的GLM估计，固定效应的最优估计为：

$$
\hat{\beta} = (X^T V^{-1} X)^{-1} X^T V^{-1} Y
$$

#### (3) 随机效应的方差 $ \sigma_u^2 $ 和误差方差 $ \sigma_\epsilon^2 $ 的估计

对于方差分量的估计，通常使用REML方法来最大化似然函数，从而估计 $ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $。在CMLM中，REML的计算步骤与MLM类似，只是维度被压缩，因此具体的计算公式与传统MLM一致，但计算效率更高。

---

### **5. CMLM求解的数值优化**

在实际中，CMLM的优化常用**EM算法**或**牛顿-拉夫森法**来迭代估计方差参数 $ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $。这里简要介绍基于EM算法的求解过程：

#### **E步**（期望步）

根据当前参数估计值，计算压缩随机效应 $ u_c $ 的条件期望和协方差。

1. 随机效应 $ u_c $ 的条件期望：

$$
\mathbb{E}(u_c | Y) = \sigma_u^2 Z_c^T V^{-1} (Y - X\beta)
$$

2. 随机效应的条件协方差：

$$
\text{Cov}(u_c | Y) = \sigma_u^2 I_q - \sigma_u^2 Z_c^T V^{-1} Z_c \sigma_u^2
$$

#### **M步**（最大化步）

在M步中，更新参数 $ \beta $、$ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $。

1. **更新固定效应** $ \beta $：

$$
\hat{\beta} = (X^T V^{-1} X)^{-1} X^T V^{-1} Y
$$

2. **更新随机效应方差** $ \sigma_u^2 $：

$$
\sigma_u^{2(t+1)} = \frac{1}{q} \left( \mathbb{E}(u_c^T u_c | Y) + \text{tr}\left( \text{Cov}(u_c | Y) \right) \right)
$$

3. **更新误差方差** $ \sigma_\epsilon^2 $：

$$
\sigma_\epsilon^{2(t+1)} = \frac{1}{n} \left( \| Y - X\hat{\beta} - Z_c \mathbb{E}(u_c | Y) \|^2 + \text{tr}\left( Z_c \text{Cov}(u_c | Y) Z_c^T \right) \right)
$$

---

### **6. CMLM的优点与局限性**

- **优点**：CMLM通过对样本聚类并构建压缩的随机效应矩阵 $ Z_c $，显著降低了模型的计算复杂度，尤其适用于大规模GWAS数据。
- **局限性**：由于CMLM基于样本聚类，聚类的质量会直接影响模型的准确性。如果聚类不合理，可能会导致一些真实的SNP-表型关联被忽略。

---

### **总结**

CMLM在MLM的基础上，通过对个体进行聚类来压缩随机效应矩阵，从而提高计算效率。通过EM算法或其他数值优化方法，CMLM能够有效地估计模型参数，并提供对群体结构校正后的SNP-表型关联分析。这种方法在大规模数据上表现尤为优异，是处理高维度、复杂表型数据的一种有效工具。

# farmCPU
**FarmCPU (Fixed and Random Model Circulating Probability Unification)** 是一种结合固定效应和随机效应的统计方法，用于基因组全关联分析（GWAS）。FarmCPU的目的是提高检测真实的SNP-表型关联的准确性，并减少虚假关联（假阳性）。与传统的混合线性模型（MLM）不同，FarmCPU通过交替应用固定效应模型和随机效应模型，能够更有效地检测多位点效应。

下面详细分析FarmCPU的数学原理和求解方法。

---

### **1. FarmCPU的基本思想**

FarmCPU的核心思想是将GWAS的分析过程分为以下两部分：

1. **固定效应模型（Fixed Effect Model）**：逐步筛选显著的SNP，并将这些SNP加入到固定效应模型中，以校正对表型的主要影响。
2. **随机效应模型（Random Effect Model）**：利用已经筛选的SNP构建一个新的随机效应，进而校正群体结构和亲缘关系对表型的影响。

通过在固定效应模型和随机效应模型之间不断循环迭代，FarmCPU能够在不增加计算负担的前提下校正多重混杂因素，减少假阳性结果。

---

### **2. FarmCPU的数学模型表示**

FarmCPU的数学模型分为两个部分：**固定效应模型（Fixed Effect Model, FEM）** 和 **随机效应模型（Random Effect Model, REM）**。

#### **(1) 固定效应模型（FEM）**

在固定效应模型中，FarmCPU逐步选择显著的SNP，将它们作为协变量纳入模型中，用于解释表型的固定效应。FEM的数学表示为：

$$
Y = X\beta + \epsilon
$$

其中：
- $ Y $ 是 $ n \times 1 $ 的表型向量，表示 $ n $ 个个体的表型值。
- $ X $ 是 $ n \times p $ 的设计矩阵，其中 $ p $ 为当前迭代中选择的显著SNP数量。每列表示一个SNP的基因型。
- $ \beta $ 是 $ p \times 1 $ 的固定效应系数向量，表示显著SNP对表型的影响。
- $ \epsilon $ 是误差项，假设其服从 $ N(0, \sigma_\epsilon^2 I_n) $。

在每次迭代中，固定效应模型的目标是找到与表型显著相关的SNP。可以通过逐步回归（Stepwise Regression）或其他筛选方法选择显著SNP。

#### **(2) 随机效应模型（REM）**

一旦选出了一些显著SNP，FarmCPU接下来利用这些SNP来构建新的随机效应，以校正群体结构和亲缘关系。随机效应模型的数学表示为：

$$
Y = P\alpha + Zu + \epsilon
$$

其中：
- $ Y $ 是 $ n \times 1 $ 的表型向量。
- $ P $ 是从FEM中筛选出的显著SNP设计矩阵。
- $ \alpha $ 是 $ p \times 1 $ 的固定效应向量，表示这些显著SNP对表型的影响。
- $ Z $ 是个体的亲缘关系矩阵，用于表征随机效应。
- $ u $ 是随机效应向量，假设其服从 $ N(0, \sigma_u^2 K) $，其中 $ K $ 是亲缘关系矩阵。
- $ \epsilon $ 是误差项。

在REM中，$ u $ 表示因群体结构带来的变异，其作用是减少固定效应模型中可能出现的假阳性关联。

---

### **3. FarmCPU的迭代求解过程**

FarmCPU通过**交替迭代固定效应模型（FEM）和随机效应模型（REM）**，逐步收敛到最终的显著SNP集合。以下是FarmCPU的具体迭代过程：

#### **Step 1：初始化**

1. 设定初始显著SNP集合为空集。
2. 根据初始模型（可能是仅包含协变量的固定效应模型）来估计表型 $ Y $ 的变异。

#### **Step 2：固定效应模型（FEM）**

1. 对每个SNP进行单一的关联分析，计算其与表型的关联统计量（如p值）。
2. 根据预设的显著性水平，选择与表型显著关联的SNP，将这些SNP纳入当前显著SNP集合。
3. 更新设计矩阵 $ X $ ，其中每一列为一个显著SNP的基因型。

#### **Step 3：随机效应模型（REM）**

1. 使用当前的显著SNP集合构建随机效应模型。
2. 通过估计随机效应中的方差分量，校正群体结构的影响。
3. 计算表型的残差并用于下一次固定效应模型的拟合。

#### **Step 4：迭代**

重复执行 Step 2 和 Step 3，不断更新显著SNP集合，直到满足以下条件之一：
- 显著SNP集合不再发生变化。
- 达到预设的迭代次数上限。

通过多次迭代，FarmCPU能够逐步选择真正与表型相关的SNP，同时校正群体结构和其他混杂效应的影响。

---

### **4. FarmCPU的求解方法**

FarmCPU使用以下统计方法来实现上述迭代过程：

#### **(1) 逐步回归（Stepwise Regression）**

逐步回归是一种在固定效应模型中用于选择显著SNP的方法。每次循环中，FarmCPU通过对所有SNP逐步计算与表型的关联性，选择显著SNP并加入固定效应模型。这种方法有助于排除不显著的SNP，提高计算效率。

#### **(2) 方差分量估计**

在随机效应模型中，FarmCPU通过估计方差分量来校正群体结构的影响。可以使用**最大似然估计（ML）**或**限制最大似然估计（REML）**来求解随机效应的方差分量。ML和REML方法能够通过优化对数似然函数，获得随机效应的最佳估计。

#### **(3) 矩阵分解和优化**

FarmCPU还采用矩阵分解技术（如奇异值分解SVD）来简化方差分量估计的计算。这些数值优化技术有助于加速模型的拟合过程，特别是在处理大规模基因组数据时，可以显著减少计算量。

---

### **5. FarmCPU的优势与局限性**

#### **优势**
- **减少假阳性**：FarmCPU通过逐步筛选显著SNP，并利用随机效应模型来校正群体结构，减少了假阳性结果的出现。
- **计算效率高**：FarmCPU通过逐步回归和矩阵优化提高了计算效率，适用于大规模GWAS分析。
- **检测多位点效应**：FarmCPU能够有效检测多位点与表型的复杂关联，提高了对多基因性状的检测能力。

#### **局限性**
- **依赖显著性筛选阈值**：FarmCPU的显著性筛选过程依赖于预设的显著性水平，不同阈值可能影响SNP的筛选结果。
- **聚类效应的稳定性**：在复杂的群体结构下，显著SNP集合可能会因为不同的初始条件而有所变化，从而影响最终的结果。

---

### **总结**

FarmCPU通过交替应用固定效应模型和随机效应模型，逐步筛选出真正与表型相关的SNP。这种方法结合了固定效应和随机效应模型的优点，能够校正群体结构和亲缘关系的影响，同时减少假阳性结果，提高了GWAS分析的精度。

# GEMMA
GEMMA（Genome-wide Efficient Mixed Model Association）是一种基于混合线性模型（MLM）的高效算法，用于基因组全关联分析（GWAS）。它的主要目标是通过混合线性模型来校正群体结构和亲缘关系带来的混杂效应，从而提高GWAS的统计功效和精确性。GEMMA的核心优势在于其数值优化方法，使得对大规模数据的计算变得更加高效。

以下是GEMMA的数学原理和求解方法的详细介绍：

---

### **1. GEMMA的混合线性模型基础**

GEMMA的模型建立在标准的混合线性模型（MLM）上，可表示为：

$$
Y = X\beta + Zu + \epsilon
$$

其中：
- $ Y $ 是 $ n \times 1 $ 的表型向量，表示 $ n $ 个个体的表型值。
- $ X $ 是 $ n \times p $ 的设计矩阵，包含固定效应的自变量（如SNP基因型、协变量等）。
- $ \beta $ 是 $ p \times 1 $ 的固定效应系数向量，表示固定效应对表型的影响。
- $ Z $ 是 $ n \times n $ 的设计矩阵，通常为单位矩阵 $ I_n $，表示随机效应直接作用于每个个体。
- $ u $ 是 $ n \times 1 $ 的随机效应向量，假设其服从 $ N(0, \sigma_u^2 K) $，其中 $ K $ 是 $ n \times n $ 的亲缘关系矩阵。
- $ \epsilon $ 是 $ n \times 1 $ 的误差项向量，假设其服从 $ N(0, \sigma_\epsilon^2 I_n) $。

目标是估计固定效应参数 $ \beta $ 和方差分量 $ \sigma_u^2 $ 与 $ \sigma_\epsilon^2 $，同时检测SNP与表型的关联。

---

### **2. GEMMA的协方差结构**

在GEMMA中，表型 $ Y $ 的协方差矩阵为：

$$
V = \sigma_u^2 K + \sigma_\epsilon^2 I_n
$$

其中：
- $ \sigma_u^2 K $ 反映了随机效应 $ u $ 的方差，包含个体间的亲缘关系。
- $ \sigma_\epsilon^2 I_n $ 表示误差项的协方差矩阵。

---

### **3. 对数似然函数的构建**

GEMMA使用**最大似然估计（MLE）** 或 **限制最大似然估计（REML）** 来估计模型中的参数。

对数似然函数可表示为：

$$
\ell(\beta, \sigma_u^2, \sigma_\epsilon^2 | Y) = -\frac{n}{2} \ln(2\pi) - \frac{1}{2} \ln |V| - \frac{1}{2} (Y - X\beta)^T V^{-1} (Y - X\beta)
$$

其中：
- $ \ln |V| $ 是协方差矩阵 $ V $ 的行列式的对数。
- 二次型项 $ (Y - X\beta)^T V^{-1} (Y - X\beta) $ 衡量了残差的平方和在协方差 $ V $ 下的加权值。

通过最大化这个对数似然函数，可以估计出固定效应参数 $ \beta $ 和方差分量 $ \sigma_u^2 $ 与 $ \sigma_\epsilon^2 $。

---

### **4. GEMMA的求解过程**

由于直接计算对数似然函数的最大值较为复杂，GEMMA通过数值优化方法来提高计算效率。GEMMA的求解方法分为以下几步：

#### **(1) 固定效应参数 $ \beta $ 的估计**

对于给定的方差分量 $ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $，可以使用广义最小二乘法（GLS）来估计固定效应参数 $ \beta $：

$$
\hat{\beta} = (X^T V^{-1} X)^{-1} X^T V^{-1} Y
$$

#### **(2) 方差分量 $ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $ 的估计**

GEMMA使用限制最大似然估计（REML）来估计方差分量 $ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $，具体方法如下：

1. **对数REML似然函数**：为消除固定效应对方差分量估计的影响，REML方法将对数似然函数中的固定效应剔除，只剩下方差分量的部分。REML的对数似然函数为：

   $$
   \ell_{\text{REML}}(\sigma_u^2, \sigma_\epsilon^2) = -\frac{1}{2} \ln |V| - \frac{1}{2} \ln |X^T V^{-1} X| - \frac{1}{2} Y^T P Y
   $$

   其中 $ P = V^{-1} - V^{-1} X (X^T V^{-1} X)^{-1} X^T V^{-1} $。

2. **谱分解（Spectral Decomposition）**：GEMMA采用谱分解法来提高计算效率。通过对亲缘关系矩阵 $ K $ 进行谱分解，将协方差矩阵 $ V $ 转化为对角矩阵，从而简化对数行列式 $ \ln |V| $ 和逆矩阵 $ V^{-1} $ 的计算。

   假设 $ K $ 的谱分解为 $ K = U \Lambda U^T $，其中 $ U $ 是正交矩阵，$ \Lambda $ 是对角矩阵，则协方差矩阵 $ V $ 可以表示为：

   $$
   V = \sigma_u^2 U \Lambda U^T + \sigma_\epsilon^2 I_n
   $$

   通过这种分解，GEMMA可以高效地计算 $ V $ 的行列式和逆矩阵。

3. **优化算法**：使用牛顿-拉夫森法等数值优化算法来求解对数REML似然函数的最大值，从而估计方差分量 $ \sigma_u^2 $ 和 $ \sigma_\epsilon^2 $。

---

### **5. GEMMA的统计检验**

一旦得到模型参数的估计值，GEMMA可以对每个SNP进行显著性检验，以评估SNP与表型之间的关联性。具体方法如下：

1. **Wald检验**：在固定效应估计中，GEMMA使用Wald检验来检验每个SNP效应是否显著。对于第 $ j $ 个SNP，其Wald检验统计量为：

   $$
   W_j = \frac{\hat{\beta}_j^2}{\text{Var}(\hat{\beta}_j)}
   $$

   其中 $ \hat{\beta}_j $ 是第 $ j $ 个SNP的固定效应估计值，$ \text{Var}(\hat{\beta}_j) $ 是其方差估计。

2. **似然比检验（LRT）**：GEMMA还可以通过似然比检验来评估模型的显著性。似然比检验比较包含和不包含SNP的两种模型的对数似然值：

   $$
   \text{LRT} = -2 \left( \ln L_{\text{null}} - \ln L_{\text{alternative}} \right)
   $$

   其中 $ \ln L_{\text{null}} $ 和 $ \ln L_{\text{alternative}} $ 分别为不包含和包含SNP的模型的对数似然值。LRT统计量服从自由度为1的卡方分布。

通过这些显著性检验，GEMMA可以评估SNP与表型的关联性，并生成GWAS分析中的关联性p值。

---

### **6. GEMMA的优点和局限性**

#### **优点**
- **高效计算**：通过谱分解和REML方法，GEMMA显著提高了MLM的计算效率，特别适用于大规模GWAS数据。
- **校正群体结构**：GEMMA的随机效应模型能够有效校正群体结构和亲缘关系的影响，减少假阳性结果。
- **适用于连续和二分类性状**：GEMMA不仅适用于连续性状的GWAS分析，也可以进行二分类性状的关联分析。

#### **局限性**
- **模型复杂性

**：GEMMA的谱分解和数值优化方法在处理非常高维数据时，可能会遇到内存和计算时间的限制。
- **亲缘关系矩阵的依赖**：GEMMA的模型依赖于准确的亲缘关系矩阵，如果矩阵构建不合理，可能影响关联结果。

---

### **总结**

GEMMA在MLM的基础上，通过引入谱分解和REML估计，极大地提高了计算效率，使得混合线性模型在大规模数据上得到应用。GEMMA的统计检验方法确保了对每个SNP与表型关联性的有效检测，使得其成为高效且可靠的GWAS分析工具。\\[\\]\\(\\)