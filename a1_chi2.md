卡方检验（Chi-Square Test）在GWAS（Genome-Wide Association Studies）研究中的应用主要用于评估每个SNP（单核苷酸多态性）位点的基因型与表型是否存在显著关联。卡方检验通过比较基因型频率的实际观测值和理论预期值来判断基因型是否与表型有相关性。

以下是卡方检验在GWAS中的详细原理及其步骤：

### 1. **研究目标：检测基因型和表型之间的关联**
在GWAS中，目标是检测某个SNP位点的不同基因型（例如，AA、Aa、aa）是否与某个二元表型（如疾病与健康）或连续表型（如身高、体重）之间存在统计学上的关联。

### 2. **卡方检验的基本原理**
卡方检验是一种非参数检验，通常用于检验分类变量的两个或多个类别之间的独立性。在GWAS中，它用于检验以下假设：
- **原假设（H0）**：SNP基因型与表型是独立的，即它们之间没有关联。
- **备择假设（H1）**：SNP基因型与表型有关联。

卡方检验通过计算观察到的基因型-表型频率与预期频率的差异，来评估基因型与表型的相关性。

### 3. **卡方检验的计算步骤**

#### 步骤 1：构建列联表
- 以二元表型（如患病和健康）为例，构建一个2×3的列联表，将表型的两个状态（如“健康”和“患病”）与SNP的三种基因型（如AA、Aa、aa）进行交叉。
  
  | 基因型 | 表型1（健康） | 表型2（患病） | 总计 |
  |:------:|:------------:|:------------:|:----:|
  |   AA   |       A       |       B       |  A+B  |
  |   Aa   |       C       |       D       |  C+D  |
  |   aa   |       E       |       F       |  E+F  |
  | 总计   |   A+C+E    |   B+D+F    | A+B+C+D+E+F |

- 列联表展示了每种基因型与每种表型的频数。

#### 步骤 2：计算预期频数

如果两个变量是独立的，它们的联合分布可以通过边际分布（即行和列的总和）相乘得到。卡方检验通过比较实际观测频率和期望频率来判断两个变量是否独立。如果实际的观测值和期望频率之间的差异显著大于预期（由卡方统计量度量），则可以推翻独立性假设。

1. **确定总体频数**：
   - 计算每个表型组（如病例和对照组）的总样本数。
   - 计算每个基因型在所有样本中的总样本数。

2. **计算边际总和**：
   - 对于每个表型，计算所有基因型的频数总和（行总和）。
   - 对于每个基因型，计算所有表型的频数总和（列总和）。

3. **计算期望频数**：

    根据独立性的假设，预期频数可以根据边缘总和计算出来。
   - 对于列联表中的每个交叉单元格，期望频数 \( E \) 可以通过以下公式计算：
     $$
     E_{ij} = \frac{(i行总和) \times (j列总和)}{(总样本数)}
     $$
     例如，AA基因型下患病表型的预期频数可以用以下公式计算：

    $$ E_{AA,患病} = \frac{(A + B) \times (B + D + F)}{A + B + C + D + E + F} $$

     对列联表中每个组合的单元格都计算出预期频数。
   - 其中，行总和是该行的基因型在所有表型中的频数总和，列总和是该列的表型在所有基因型中的频数总和，总样本数是整个研究的样本总数。如果两个变量是独立的，它们的联合分布可以通过边际分布（即行和列的总和）相乘得到。


#### 步骤 3：计算卡方统计量
使用以下公式计算卡方统计量：

$$
\chi^2 = \sum \frac{(O_{ij}  - E{ij})^2}{E_{ij}}
$$

其中:
- $O_{ij}$是是第 i 行第 j 列的实际观测频率（Observed Frequency）;
- $E_{ij}$是第 i 行第 j 列的期望频率（Expected Frequency）。
- 卡方统计量累加了每个单元格的差异平方与预期值的比值。

#### 步骤 4：确定自由度
卡方检验的自由度是通过以下公式计算：

$$
df = (行数 - 1) \times (列数 - 1)
$$

在2×3的列联表中，自由度为：

$$
df = (2 - 1) \times (3 - 1) = 2
$$

#### 步骤 5：确定p值
根据卡方统计量和自由度，查找卡方分布表或使用统计软件计算p值。p值用于判断是否拒绝原假设。如果p值小于预设的显著性水平（如0.05），则拒绝原假设，说明SNP与表型有显著关联。

### 4. **卡方检验的应用示例**
假设我们研究一个SNP位点的基因型（AA、Aa、aa）与某种疾病（患病或健康）之间的关联，结果如下：

| 基因型 | 健康 | 患病 | 总计 |
|:------:|:----:|:----:|:----:|
|   AA   |  50  |  20  |  70  |
|   Aa   |  30  |  30  |  60  |
|   aa   |  20  |  50  |  70  |

总共有200个个体。首先，计算预期频数。例如，健康人群中的AA基因型的预期频数为：

$$
E_{AA,健康} = \frac{(70 \times 100)}{200} = 35
$$

然后对每个单元格重复上述计算，得到所有预期值。接着使用卡方公式计算每个单元格的(O - E)^2 / E并进行累加，最终得出卡方统计量，再根据自由度和卡方分布表获得p值。

### 5. **卡方检验的局限性**
- **适用于二元表型**：卡方检验主要适用于二元表型，对于连续性状的表型，卡方检验不适合。
- **忽略复杂的遗传背景**：卡方检验不能处理复杂的遗传背景，例如群体结构和亲缘关系的影响，因此在复杂性状中，卡方检验可能会产生虚假关联（即假阳性）。
- **统计效能有限**：对于大规模数据集，卡方检验的效能可能有限，无法处理多位点效应或基因-环境交互。

### 6. **与其他方法的比较**
相比GLM、MLM等模型，卡方检验是一种相对简单的方法，只适用于SNP和表型之间的直接关联分析。它不考虑群体结构、亲缘关系等潜在混杂因素。对于单一位点的关联检测，卡方检验有时会比复杂模型更容易解释，但其缺点是无法处理多SNP效应或复杂的遗传背景。

### 结论
卡方检验在GWAS中的应用是评估SNP与二元表型之间的关联，基于观察值和预期值的差异来判断是否存在显著关联。虽然它是一种简单的统计方法，但由于未考虑群体结构和亲缘关系等复杂因素，其结果可能产生假阳性，因此在实际应用中常与其他模型联合使用，如MLM等复杂模型。