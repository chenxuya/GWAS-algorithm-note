[Learning the histone codes with large genomic windows and three-dimensional chromatin interactions using transformer](https://www.nature.com/articles/s41467-022-34152-5)
## Chromoformer：利用三维染色质相互作用的Transformer模型解码组蛋白修饰代码

### 1. 背景与研究目的
- 基因表达的调控受到多种因素的影响，其中组蛋白修饰（Histone Modifications，HMs）在染色质可及性和基因表达调控中起到关键作用。
- 大多数现有模型主要集中在靠近转录起始位点（TSS）周围的狭窄线性区域，忽略了三维染色质相互作用带来的远程调控信息。
- 本研究提出一种新的Transformer架构模型——**Chromoformer**，结合3D染色质相互作用的组蛋白修饰数据，旨在解码基因表达调控的复杂机制。

### 2. 模型概述
- Chromoformer是一个基于Transformer的深度学习架构，设计用于整合广泛基因组窗口和染色质三维相互作用信息，以提高基因表达预测的准确性。
- 模型包含三个关键模块：**Embedding Transformer**、**Pairwise Interaction Transformer**和**Regulation Transformer**，每个模块对应不同层次的基因调控信息整合。
- 模型最终生成一个多尺度调控嵌入（multi-scale regulatory embedding），用于基因表达状态的预测。

---

### 3. 数据预处理与输入数据格式
- **组蛋白修饰数据**：从ChIP-seq实验中获取TSS周围40 kbp区域内的7种主要组蛋白修饰信号（H3K4me1、H3K4me3、H3K9me3、H3K27me3、H3K36me3、H3K27ac、H3K9ac）。
- **输入数据结构**：对每种组蛋白修饰信号进行100 bp的分区，计算每个区间的平均信号读数，并进行对数变换。最终形成的输入数据矩阵为每个基因的 $ n \times 7 $ 的矩阵（n为窗口数量，7为组蛋白修饰种类）。
- **三维相互作用数据**：使用高通量染色质相互作用数据（如Hi-C、pcHi-C）提供核心启动子和pCREs的相互作用频率。数据经过归一化处理，以便模型更关注高频交互区域。

---

### 4. 模型结构详解

#### 4.1 Embedding Transformer（嵌入Transformer）
- **功能**：负责处理核心启动子附近的组蛋白修饰信号，生成TSS区域的嵌入表示。
- **架构**：
  - **输入层**：每个组蛋白修饰信号通过线性投影转换为统一的向量表示。
  - **位置编码**：通过正弦和余弦位置编码，加入不同窗口位置的空间信息，使模型能够捕捉不同组蛋白修饰信号间的依赖关系。
  - **多头自注意力**：利用多头注意力机制计算信号之间的相似性，并将这些全局依赖性信息整合到每个位置的表示中。
- **输入数据及生物学含义**：
  - 输入为TSS区域的组蛋白修饰信号矩阵，反映了基因启动区域的组蛋白修饰状态，这些状态直接与基因启动的潜在活性相关。
- **输出数据及生物学含义**：生成的嵌入向量表示了TSS区域的综合调控状态，为后续模块提供了局部调控信息。
  
#### 4.2 Pairwise Interaction Transformer（成对交互Transformer）
- **功能**：用于建模启动子与远程调控元件pCREs之间的交互关系，生成成对交互嵌入。
- **架构**：
  - **编码器-解码器注意力**：核心启动子嵌入作为解码器输入，pCREs组蛋白信号作为编码器输入，模型通过注意力得分计算启动子和pCREs之间的关系。
  - **多头注意力**：通过多头注意力机制并行计算不同pCREs对启动子的影响，增强模型捕捉复杂调控模式的能力。
- **输入数据及生物学含义**：
  - 核心启动子嵌入表示TSS的局部组蛋白修饰状态，pCREs的组蛋白修饰信号反映远程调控信号。
- **输出数据及生物学含义**：输出的成对交互嵌入向量整合了特定pCRE对核心启动子的调控作用，为预测提供了远程调控的信息支持。

#### 4.3 Regulation Transformer（调控Transformer）
- **功能**：整合核心启动子和所有pCREs的调控信息，生成一个多尺度调控嵌入向量，用于基因表达预测。
- **架构**：
  - **门控自注意力**：在注意力计算中加入归一化的3D相互作用频率，增强高频染色质交互位点的权重。
- **输入数据及生物学含义**：
  - 核心启动子嵌入表示TSS的直接调控信息，成对交互嵌入表示每个pCRE对启动子的调控作用。
  - 归一化的3D相互作用频率帮助模型优先关注染色质中具有高频交互的调控区域。
- **输出数据及生物学含义**：多尺度调控嵌入向量是模型最终整合的调控状态，包含了基因调控过程中的所有层次信息，为预测基因表达状态提供全面支持。

---

### 5. 模型训练过程与损失函数
Chromoformer模型支持三种不同的基因表达预测任务，每种任务对应不同的损失函数：

1. **二分类任务（Chromoformer-clf）**：
   - 目标：将基因表达状态预测为“高表达”或“低表达”。
   - 损失函数：**交叉熵损失（Cross-Entropy Loss）**。
   - 公式：
     $$
     \text{Loss} = -\frac{1}{N} \sum_{i=1}^N \left[ y_i \log(\hat{y}_i) + (1 - y_i) \log(1 - \hat{y}_i) \right]
     $$
     其中，$ N $为样本数量，$ y_i $为实际标签，$ \hat{y}_i $为预测概率。

2. **表达量回归任务（Chromoformer-reg）**：
   - 目标：直接预测基因的表达量（log2 RPKM）。
   - 损失函数：**均方误差（Mean Squared Error, MSE）**。
   - 公式：
     $$
     \text{Loss} = \frac{1}{N} \sum_{i=1}^N (y_i - \hat{y}_i)^2
     $$
     其中，$ y_i $为实际表达量值，$ \hat{y}_i $为模型的预测值。

3. **表达倍数变化回归任务（Chromoformer-diff）**：
   - 目标：预测不同细胞类型间的基因表达倍数变化。
   - 损失函数：同样使用**均方误差（MSE）**，用于评估预测的fold-change值与实际fold-change值的差异。

通过反向传播更新模型参数，使得每个模块能够逐步优化其注意力权重和嵌入表示，以提升预测精度。

---

### 6. 三维相互作用频率的数据格式与获取
- **数据格式**：
  - **矩阵**：以矩阵形式存储，不同启动子和pCREs的相互作用频率作为矩阵的元素。
  - **列表**：以启动子-远程调控区域对的形式，每对用一个相互作用频率数值表示。

- **数据来源**：三维相互作用频率数据通过高通量染色质相互作用测序技术（如Hi-C、pcHi-C）获得。
  - 这些数据通常经过去除背景信号和归一化处理。
  - 数据库来源：可以通过3DIV或ENCODE等公共数据库获取，提供了归一化的染色质相互作用数据。

---

### 7. 总结
- Chromoformer

通过三层次Transformer架构，整合局部和远程的组蛋白修饰信息，能够有效解码基因调控的复杂机制。
- 该模型成功结合了3D染色质结构信息，使其在基因表达预测中表现优于传统的深度学习模型。
- 模型在不同细胞类型的基因表达预测、基因间表达差异预测等任务中均表现出色，为组蛋白修饰和基因表达调控的研究提供了新的视角和工具。
